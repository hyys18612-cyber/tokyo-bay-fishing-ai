import tweepy
import os
import datetime
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
import matplotlib.patheffects as pe
from matplotlib import font_manager as fm
from logic import FishingPredictor, MAP_EXTENT, VISUAL_OFFSETS

# -------------------------------------------
# 1. èªè¨¼æƒ…å ±ã®èª­ã¿è¾¼ã¿
# -------------------------------------------
consumer_key = os.environ.get("TWITTER_API_KEY")
consumer_secret = os.environ.get("TWITTER_API_SECRET")
access_token = os.environ.get("TWITTER_ACCESS_TOKEN")
access_token_secret = os.environ.get("TWITTER_ACCESS_TOKEN_SECRET")

# -------------------------------------------
# 2. Twitter API èªè¨¼ (v1.1ã¨v2ã®ä¸¡æ–¹æº–å‚™)
# -------------------------------------------
# v2: ãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ç”¨
client = tweepy.Client(
    consumer_key=consumer_key,
    consumer_secret=consumer_secret,
    access_token=access_token,
    access_token_secret=access_token_secret
)

# v1.1: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨
auth = tweepy.OAuth1UserHandler(
    consumer_key, consumer_secret, access_token, access_token_secret
)
api = tweepy.API(auth)

# -------------------------------------------
# 3. ç”»åƒç”Ÿæˆé–¢æ•° (Mapä½œæˆ)
# -------------------------------------------
def create_fishing_map(data, date_str):
    # ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
    font_path = "ipaexg.ttf"
    if os.path.exists(font_path):
        fm.fontManager.addfont(font_path)
        plt.rcParams['font.family'] = 'IPAexGothic'
    
    # å›³ã®ä½œæˆ
    fig, ax = plt.subplots(figsize=(8, 8))
    
    # åœ°å›³ç”»åƒã®èª­ã¿è¾¼ã¿ (app.pyã¨åŒã˜ç”»åƒã‚’ä½¿ç”¨)
    try:
        if os.path.exists('tokyo_bay_map.png'):
            img = mpimg.imread('tokyo_bay_map.png')
            ax.imshow(img, extent=MAP_EXTENT, aspect='auto', alpha=1.0, zorder=0)
        else:
            # ç”»åƒãŒãªã„å ´åˆã¯æ°´è‰²èƒŒæ™¯
            ax.set_facecolor('#d4e6f1')
    except:
        ax.set_facecolor('#d4e6f1')

    # ç¯„å›²è¨­å®š
    ax.set_xlim(MAP_EXTENT[0], MAP_EXTENT[1])
    ax.set_ylim(MAP_EXTENT[2], MAP_EXTENT[3])
    ax.axis('off')

    # ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
    ax.set_title(f"æ±äº¬æ¹¾ é‡£æœäºˆå ± {date_str}", fontsize=20, fontweight='bold', color='#0e4d92', pad=20)

    # ãƒã‚¤ãƒ³ãƒˆã®ãƒ—ãƒ­ãƒƒãƒˆ
    for item in data:
        x, y = item['lon'], item['lat']
        # ä½ç½®å¾®èª¿æ•´
        if item['name'] in VISUAL_OFFSETS:
            off = VISUAL_OFFSETS[item['name']]
            x += off['lon']; y += off['lat']
        
        cpue = item['total_cpue']
        size = 400 + (cpue * 60) # å°‘ã—å¤§ãã‚ã«
        colors = {'S':'#e74c3c', 'A':'#e67e22', 'B':'#f1c40f', 'C':'#2ecc71', 'D':'#95a5a6'}
        color = colors.get(item['rank'], 'gray')
        
        # ãƒ‰ãƒƒãƒˆæç”»
        ax.scatter(x+0.003, y-0.003, s=size, c='black', alpha=0.15, zorder=9, edgecolors='none') # å½±
        ax.scatter(x, y, s=size, c=color, alpha=0.9, edgecolors='white', linewidth=3, zorder=10) # æœ¬ä½“
        
        # ãƒ©ãƒ™ãƒ«æç”»
        label_txt = f"{item['name']}\n{cpue:.1f}"
        ax.text(x, y-0.015, label_txt, fontsize=14, fontweight='bold', ha='center', va='top', 
                 color='white', path_effects=[pe.withStroke(linewidth=4, foreground="#2c3e50")], zorder=11)

    # è‘—ä½œæ¨©è¡¨è¨˜ãªã©
    ax.text(0.99, 0.01, "Generated by TokyoBayFishingAI", transform=ax.transAxes,
            fontsize=10, color='gray', ha='right', va='bottom')

    # ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
    filename = "forecast_map.png"
    plt.savefig(filename, bbox_inches='tight', dpi=100)
    plt.close()
    return filename

# -------------------------------------------
# 4. ãƒ¡ã‚¤ãƒ³å‡¦ç†
# -------------------------------------------
try:
    predictor = FishingPredictor()
    
    # æ˜æ—¥ã®æ—¥ä»˜
    tomorrow = datetime.date.today() + datetime.timedelta(days=1)
    date_str = tomorrow.strftime("%Y-%m-%d")
    disp_date = tomorrow.strftime("%m/%d")
    
    points = ["æµ¦å®‰", "è‹¥æ´²", "å¸‚åŸ", "æ±æ‰‡å³¶", "å¤§é»’", "ç£¯å­"]
    
    # äºˆæ¸¬å®Ÿè¡Œ
    results = predictor.run_prediction(date_str, points)
    
    # 1ä½ã‚’å–å¾—
    sorted_results = sorted(results, key=lambda x: x['total_cpue'], reverse=True)
    best_spot = sorted_results[0]
    
    # ç”»åƒç”Ÿæˆ
    print("ğŸ¨ ç”»åƒã‚’ç”Ÿæˆä¸­...")
    image_file = create_fishing_map(results, disp_date)
    
    # ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (API v1.1)
    print("ğŸ“¤ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...")
    media = api.media_upload(filename=image_file)
    
    # ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã®ä½œæˆ
    rank_emoji = {'S': 'ğŸ”¥', 'A': 'ğŸ˜', 'B': 'ğŸ˜€', 'C': 'ğŸ˜', 'D': 'ğŸ˜­'}.get(best_spot['rank'], 'ğŸ¤”')
    
    tweet_text = f"""ğŸ“Š {disp_date} æ±äº¬æ¹¾é‡£æœäºˆå ±

æ˜æ—¥ã®ã‚¤ãƒã‚ªã‚·ã¯ã€{best_spot['name']}ã€‘ï¼
æœŸå¾…åº¦: {best_spot['rank']} {rank_emoji} (æŒ‡æ•°: {best_spot['total_cpue']:.1f})

å¤©æ°—: {best_spot['weather']}
é¢¨é€Ÿ: {best_spot['wind']}m

ğŸ‘‡ é­šç¨®åˆ¥ã®è©³ç´°ãƒ»ä»–ã‚¨ãƒªã‚¢ã¯ã“ã¡ã‚‰
https://tokyo-bay-fishing-ai-ypd33onggtcjxnh69ryijz.streamlit.app/

#æ±äº¬æ¹¾ #é‡£ã‚Š #ã‚·ãƒ¼ãƒã‚¹ #ã‚¢ã‚¸ãƒ³ã‚°
"""

    # æŠ•ç¨¿å®Ÿè¡Œ (API v2)
    print("ğŸ¦ ãƒ„ã‚¤ãƒ¼ãƒˆä¸­...")
    client.create_tweet(text=tweet_text, media_ids=[media.media_id])
    
    print("âœ… ç”»åƒä»˜ããƒ„ã‚¤ãƒ¼ãƒˆæˆåŠŸï¼")
    print(tweet_text)

except Exception as e:
    print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
